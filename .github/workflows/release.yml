name: Publish PDFs on Release

on:
  push:
    tags:
      - '*'

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Docker image
        run: docker build -t lilypond-builder .
      
      - name: Find and convert all .ly files to PDF
        run: |
          mkdir -p output
          find . -name "*.ly" -type f | while read lyfile; do
            echo "Converting: $lyfile"
            filename=$(basename "$lyfile" .ly)
            dirname=$(dirname "$lyfile")
            docker run --rm -v "$(pwd):/app" -w /app lilypond-builder \
              lilypond --output="output/$filename" "$lyfile"
          done
      
      - name: List generated PDFs
        run: ls -lh output/
      
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
      
      - name: Upload PDFs to Release
        run: |
          for pdf in output/*.pdf; do
            if [ -f "$pdf" ]; then
              filename=$(basename "$pdf")
              echo "Uploading: $filename"
              curl -L \
                -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/octet-stream" \
                --data-binary "@$pdf" \
                "${{ steps.create_release.outputs.upload_url }}?name=$filename"
            fi
          done
